---
title: 操作系统03-处理机调度与死锁
date: 2020-07-22 14:22:46
---

## 3.1 概述

### 处理机调度概述

处理机调度是指CPU资源在可运行实体间的分配。在多道程序系统中，通常会有多个进程或线程同时竞争CPU。如果只有一个CPU可用，就必须选择下一个可用的进程或线程。在操作系统中，完成选择工作的这一部分称为调度程序，该程序使用的算法称为调度算法。 

### 处理器调度与进程状态转换

![处理器调度与进程状态转换](./操作系统03-处理机调度与死锁/处理器调度与进程状态转换.png)

### 处理机调度的类型

处理器调度的层次

- 高级调度
- 中级调度
- 低级调度

### 高级调度

多道批处理OS中，高级调度又称为作业调度，功能是按照某种原则从后备作业队列中选取作业进入主存，并为作业做好运行前的准备工作和完成后的善后工作。

![高级调度](./操作系统03-处理机调度与死锁/高级调度.png)

### 中级调度

- 为提高系统吞吐量和内存利用率而引入的一内---外存对换功能（换出时，进程为挂起或就绪驻外状态）。 
- 决定那些进程被允许参与竞争处理器资源，起到短期调整系统负荷的作用。
- 所用的方法是把一些进程换出主存，从而使之进入“挂起”状态，不参与进程调度，以平顺系统的操作。

### 低级调度

- 又称进程调度或短程调度，它的主要功能是按照某种原则把处理其分配给就绪进程。
- 进程调度程序是操作系统最为核心的部分，进程调度策略的优劣直接影响到整个系统的性能。
- 主要是由分派程序（Dispatcher）分派处理机。

1. 非抢占方式：简单，时效性差
2. 抢占方式
   1. 时间片原则
   2. 优先权全责
   3. 短作业优先原则

### 选择调度算法的原则

为比较CPU调度算法，人们提出了很多调度准则，用来进行比较特征对确定最佳算法时产生的影响。常用的准则如

1. 吞吐量
2. CPU利用率
3. 周转时间
4. 响应时间
5. 就需等待时间

### 调度算法计算的几个指标

#### 评价周转时间

$$T = \frac{1}{n}[ \sum_{i=1}^n T_i]$$

#### 平均带权

$$W = \frac{1}{n}[ \sum_{i=1}^n \frac{T_i}{T_s}]$$

可见带权w越小越好，$T_s$为实际服务时间。

#### 平均等待时间

进程i从进入就绪队列的那一刻$t_{ir}到获得CPU的那一刻$t_{ip}$所经历的时间成为它的等待时间$W_i$，即$W_i=t_{ip}-t_{ir}$,那么n个进程的评价等待时间W为：

$$W = \frac{1}{n}[ \sum_{i=1}^n W_i]$$

#### 选择调度方式和算法的几个原则(续)

- 面向用户的原则
  - 响应时间快：键盘提交请求到首次响应时间
    1. 输入传送时间
    2. 处理时间
    3. 响应传送时间
  - 截止时间的保证（特别适用于实时系统）各类资源的平衡利用。
  - 优先权准则：（即需要抢占调度）
- 面向系统的原则
  - 吞吐量高：单位时间完成作业数
  - 处理机利用率好：（CPU相对贵，特别适用于大中型多用户系统）
  - 各类资源的平衡利用

## 3.2 作业调度

### 作业

作业（Job）是用户提交给操作系统计算的一个独立任务。在批处理系统中，作业进入系统后先驻留在外存上，因此，需要由作业调度来将它们分批地装入内存。因此作业调度是适用于批处理系统的一种调度方式。

### 作业控制块(JCB)

- 在多道批处理系统中通常有上百个作业被放在输入井（外存）中。为了管理和调度作业，系统为每个作业设置了一个作业控制块。
- JCB记录该作业的有关信息。不同系统的JCB的组成内容有所区别，主要包括作业名、资源要求、资源使用情况、类型级别、状态等。
- JCB是作业在系统中存在的唯一标志。作业进入系统时由spooling系统为每个作业建立一个JCB；当作业退出系统时，其JCB也一起被撤销。

### 作业调度的主要功能

作业调度：按照某种算法从作业后备队列中挑选作业进入主存中运行。

**具体功能**

1. 按照某种原酸从昨夜后备队列中挑选作业；
2. 为选中的作业分配主存和外设资源；
3. 为选中的作业建立相应的进程；
4. 构造和填写作业运行时所需的表格，如作业表；
5. 作业结束时完成作业的善后处理工作，如回收资源，输出结果，撤销全部进程（PCB）和JCB。

### 调度一个作业的时机

- 作业完成后
- 有新作业提交
- 处理机利用率较低

### 常用的作业调度算法

以单道批处理系统为例，常用的作业调度算法有：

- 先来先服务（FCFS）算法
- 最短作业优先（SJF）算法
- 最高响应比优先（HRF）算法  响应比 ＝1+已等待时间/估计运行时间
- 均衡调度算法 

## 3.3 进程调度

进程调度是任何一种操作系统都必须具有的功能，它在很大程度上决定了系统的性能。因此，如何把处理机有效地分配给进程、如何在多个请求进程中选择某个进程运行，都是进程调度需要解决的问题。

### 进程调度的主要功能

进程调度根据PCB描述的信息进行调度，其主要功能如下：

- 记录和保持系统中所有进程的有关情况和状态特征 
- 决定分配策略 
- 实施处理机的分配和回收

### 处理机的调度的几种情况

- 在创建一个新进程后，需要决定是运行父进程还是运行子进程。
- 在一个进程退出时必须作出调度。
- 在一个I/O中断发生时，必须作出调度。 
- 分时系统中，现行进程的时间片用完的情况下，需要重新选择新进程在处理机上运行。
- 当一个运行进程阻塞在I/O或信号量上或由于其它原因阻塞时，必须选择另一个进程运行。

### 进程调度方式

从调度方式上看，进程调度有两种类型：

- 抢占式调度：剥夺调度方式，指当一个进程正在处理机上执行时，系统可以根据规定原则剥夺分配给它的CPU并分配给其他进程使用。
- 非抢占式调度：非剥夺调度方式，指挑选一个进程或县城运行后，该进程或线程一直占有CPU，直至被阻塞，或者直到该进程或线程自动释放CPU为止。

### 实时调度算法 

实现实时调度的基本条件

- 提供必要的调度信息
  - 就绪时间、开始截止时间和完成截止时间
  - 处理时间、资源要求、优先级
- 系统处理能力强
  - 但处理机情况下必须满足的限制条件
  - N个处理机情况下必须满足的限制条件
- 采用抢占式调度机制
- 具有快速切换机制
  - 外部中断的快速响应能力
  - 快速的任务分派能力

### 实时调度算法 

实时调度算法必须满足实时系统对响应时间的严格要求。可用于实时系统的调度算法:

- 非抢占式优先权调度算法
  - 非抢占式轮转调度算法
  - 非抢占式优先调度算法
- 抢占式调度算法
  - 基于时钟中断抢占的优先权调度算法。
  - 立即抢占的优先权调度算法。 

### 调度算法

- 先来先服务FIFO调度算法
- 优先级调度算法
- 时间片调度算法
- 短作业优先调度算法
- 最短剩余时间优先调度算法
- 最高响应比优先调度算法
- 多级反馈队列调度算法

#### 1. 先来先服务FIFO调度算法

- 原则：按照作业到的系统或进程进入就绪队列的先后顺序来选择。
- 特点：非抢占策略（进程一旦占有处理机就一直运行下去，直到该进程完成其他工作或因而等待某事件而不能继续运行时才释放处理机）
- 缺点：提高了平均的作业周转时间。
- 应用：不作为主要的调度策略，油漆不能用于分时和实时系统。常结合其他的调度策略综合使用。

#### 2. 优先级调度算法

- 原则：按照进程的优先级大小来调度，高优先级进程得到优先处理。（动态优先数）
- 优先权的类型
  - 静态优先权：优先权在创建时 确定，在进程的整个运行期间保持不变。
  - 动态优先权：进程创建时获得的优先权，随进程的推进而改变。
  - 决定静态优先权的依据：进程类型、进程对资源的需求、用户要求。
- 方法
  1. 非抢占的优先级调度法
  2. 可抢占的优先级调度法：UNIX系统进程调度算法。
- 存在的问题和解决方案
  - 无穷阻塞（indefinite blocking）或饥饿（starving问题）
  - 老化（aging）技术

#### 3. 时间片轮转调度算法

- 原则：按照进程到达时间先后顺序组织进程就绪队列，选择队列中的第一个进程（FIFO）服务。
- 特点：可抢占策略（若时间片用完后进程仍未完成任务，也必须释放处理机给下一个就绪进程，自己返回就绪队列末尾重新排队）
- 时间片大小：大于多数分时用户的询问时间（略大于多数进程从计算到输入输出要求之间的时间间隔）。
- 应用
  - 用户进程调度。
  - 特别适合于分时系统。

- 响应时间T=Nq
- N:系统中的进程数；q: 时间片的大小。
  1. 当系统要求的响应时间越小，时间片就越短；
  2. 系统允许的最大进程数越多，时间片也越短；
  3. 基本命令应该在一个时间片内执行完。

#### 4. 短作业优先调度算法

- 原则：从昨夜后背队列中挑选所需运行时间最短的作业进入主存运行。
- 特点：非抢占策略。
- 有点：与FCFS算法相比，ST(P)F算法能有效降低作业的平均等待时间和提高系统的吞吐量。
- 缺陷
  1. 对长作业不利，长作业可能长时间得不到调度。
  2. 不能保证紧迫作业的及时处理，因为该算法不考虑作业的紧迫程度。
  3. 作业长短跟进用户的估计而定，故不一定能真正做到短作业优先
- 应用：用户作业调度。不适合于分时系统。

#### 5. 最短剩余时间优先调度算法

短作业优先调度算法的变型。

- 原则：让运行到作业完成时所需运行时间最短的进程优先得到处理，包括新进入系统的进程。
- 特点：可抢占策略。
- 有点：降低作业的平均等待时间；
- 缺点：估计运行时间；系统开销大。
- 应用：可用于分时系统。

#### 6. 最高响应比优先调度算法

- 作业的动态优先数：响应比=（等待时间+要求数据时间）/要求服务时间，即RR=（w+s）/s=1+w/s，因此响应比一定是大于1的。
- 基本思想：把CPU分配给就绪队列中相应比最高的进程。
- 特点：非抢占策略
  1. 如果作业的等待时间相同，则要求服务的时间逾短，其优先权逾高，因此该算法有利于短作业，保持了短作业有线的特点；
  2. 当要求服务的时间相同，作业的优先权决定于其等待时间，因而是实现了先来先服务，满足了用户的分时要求；
  3. 对于长作业，当其等待时间足够长时，其优先权便可升到很高，从而也可获得处理机，避免了长作业长时间得不到服务的现象。
- 缺点：在利用该算法时，每次进行调度之前，都需先进性响应比计算，这会增加系统的开销。

### 处理机调度的步骤

在进程调度时，处理机调度需要经历三个主要步骤

- 保存“下降”进程现场：系统初启时无“下降”进程，“下降”进程为终止进程时，这一步不执行；
- 选择将要运行的进程—“上升”进程 ：若此时就绪队列为空，则选择系统中一个特殊的死循环进程——闲置进程。 
- 恢复“上升”进程的现场

### 线程调度的主要功能

- 线程调度的主要功能是选择一个适当的线程到处理机上去执行并进行描述表的切换。
- 对于用户级线程，内核并不知道线程的存在，所以内核还是和以前一样工作，即采用前面所介绍的方法进行进程调度。 
- 对于内核级线程，是由内核选择一个特定的线程运行，它不用考虑该线程属于哪个进程。 

### 算法的评价

- 吞吐率：在给定时间内，一个计算机系统所完成的总工作量。
- 周转时间：讲一个作业提交给计算机系统后到该作业完成并将结果返回给用户所需要的时间。
- 响应时间：指从用户向计算机发出一个命令到计算机把相应的执行结果返回给用户所需要的时间。
- 设备利用率：指输入输出设备的使用情况。在一些对I/O处理能力要求高的系统中，设备利用率高也是一个衡量调度策略好坏的重要指标。

## 3.4 死锁

### 死锁的基本概念

死锁就是两个或两个以上的进程等候着一个永远不会发生的事件时所取的一种系统状态。

![死锁的基本概念](./操作系统03-处理机调度与死锁/死锁的基本概念.png)

### 死锁问题的提出

产生死锁的原因：

1. 竞争共享资源  
2. 进程推进顺序不当

![产生死锁的原因](./操作系统03-处理机调度与死锁/产生死锁的原因.png)

### 资源的概念

![资源的概念](./操作系统03-处理机调度与死锁/资源的概念.png)

### 死锁的必要条件

![死锁的必要条件](./操作系统03-处理机调度与死锁/死锁的必要条件.png)

### 死锁的预防

#### 预先静置分配法：破坏部分分配条件

- 策略
  - 作业调度时，仅当系统满足作业运行时所需的全部资源时，才把该作业调入内存运行。
  - 在作业运行前一次性将其所需的全部资源分配给它，于是在作业运行过程中不再会提出新的资源请求。
- 缺点：资源浪费！
- 改进：程序->程序步；资源分配以程序步为单位。
- 有点：减少资源浪费，利用率提高。
- 不足
  - 增加了应用系统的设计和执行开销。
  - 作业所需资源不能一次性满足->可能无限延迟。
  - 作业所需资源逐步累计->占而不用->浪费资源。

#### 有序资源适用法：破坏循环等待条件

- 策略：把系统中的全部资源分别分给一个特定的序号，并且要求每个进程均应严格地按照序号递增的次序请求资源。
- 有点：基于动态分配方法，资源利用率较前法提高。
- 关键：小心安排资源序号。
- 问题
  1. 各类资源序号一经安排，不宜经常地随意改动；
  2. 资源序号尽可能反应多数作业的实际使用资源的顺序，但总有不合适的作业而造成资源浪费。

### 死锁的避免和银行家算法

- 预防：破坏死锁必要条件之一，保证死锁不发生（限制调价较强，实现简单，但严重损害了系统性能）
- 避免：不严格限制必要条件（限制条件较弱，可能获得满意结果）
- 安全状态：指系统按照某种进程顺序（如P1,P2，...Pn）来为每个进程分配其所需资源，直到最大需求，使每个进程都可以顺利完成，此时系统所处状态为安全状态。
- 不安全状态
  - 若系统没有这样一个安全序列，则系统处于不安全装填。
  - 如果不按照安全序列分配资源，则系统可能由安全状态进入不安全状态。

### 银行家算法

- 避免死锁算法中最有代表性的算法是Dijkstra E.W于1968年提出的银行家算法。
- 该算法需要检查申请者对资源的最大需求量，如果系统现存的各类资源可以满足申请者的请求，就满足申请者的请求。
- 这样申请者就可很快完成其计算，然后释放它占用的资源，从而保证了系统中的所有进程都能完成，所以可避免死锁的发生。

### 死锁检测

- 条件：允许死锁必要条件存在，也未采用避免死锁的算法（提高资源利用率）——故死锁可能发生，需检测。
- 定义：实际地检查系统中是存在死锁，并标出那些进程和资源被牵扯在死锁中。
- 应用：允许前三个死锁的必要条件存在的系统中，检查系统中是否存在循环等待条件。
- 方法
  - 资源分配图
  - 如果资源分配图中不存在环路，则系统不存在死锁；繁殖如果资源分配图中存在环路，则系统可能存在死锁，也可能不存在死锁。

### 资源分配图

![资源分配图](./操作系统03-处理机调度与死锁/资源分配图.png)

#### 简化资源分配图

##### 化简

一个进程的所有资源要求均能被满足，则该进程得到其所需全部资源从而不断去的进展，直至完成全部任务并释放出全部资源。->移走所有从资源触发指向该进程的有向边，和从该进程触发指向资源的诸有向边->该进程成为孤立的节点。

##### 死锁定理

当且仅当资源某状态S所对应的资源分配图是不可化简的，则S是死锁状态。而不可被化简的进程既是死锁的进程。反之，若状态S所对应的资源分配图是可化简的，则S是安全状态。

**资源分配图的化简结果与化简顺序无关，最终结果是相同的。**

### 死锁恢复

- 强制性地从系统中撤消进程并剥夺它们的资源给剩下的进程使用。
  - 撤消进程的原则：
    - 进程的优先数；
    - 重新启动它并运行到当前撤消点所需的代价；
    - 作业的外部代价：即与此进程相关的作业类型都可以有其相应的固定撤消代价。
- 挂起和解挂机构：
  - 从被挂起进程那里强占资源以解除死锁。