---
title: 计算机原理03-内存存储器
date: 2020-04-16 23:12:04
---

# 存储器概述

## 存储器分类

- 按存储介质分类
  - 磁表面
  - 半导体存储器
- 安存储方式分类
  - 随机
  - 顺序存储（磁带）
- 按读写功能分类
  - ROM
  - RAM
- 按信息的可保存性分类
  - 永久性
  - 非永久性
- 按存储器系统中的作用分类
  - 主存
  - 辅存
  - 缓存

## 存储器的特点

1. 速度快的存储器价格贵，容量小；
2. 价格低的存储器速度慢，容量大

### 存储器分级结构

- 高速缓冲存储器简称cache，它是计算机系统中的一个高速小容量半导体存储器。
- 主存储器简称主存，是计算机系统的主要存储器，用来存放计算机运行期间的大量程序和数据。
- 外存储器简称外存，它是大容量辅助存储器。

![存储器的分级结构1](./计算机原理03-内存存储器/存储器的分级结构1.png)

![存储器的分级结构2](./计算机原理03-内存存储器/存储器的分级结构2.png)

![存储器的分级结构3](./计算机原理03-内存存储器/存储器的分级结构3.png)

## 存储器的技术指标

- 字存储单元：存放一个机器字的存储单元。
- 字节存储单元：存放一个字节的单元。
- 存储容量：指一个存储器中可以容纳的存储单元总数。
- 存取时间：又称存储器访问时间，指一次读操作命令发出到该操作完成，将数据读出到数据总线上所经历的时间。通常取写操作时间等于读操作时间，故称为存储器存取时间。
- 存储周期：指连续启动两次读操作所需间隔的最小时间。通常，存储周期略大于存取时间。
- 存储器带宽：单位时间里存储器所存取的信息量，通常以位/秒或字节/秒做度量单位。

## 主存

主存（内部存储器）是半导体存储器。根据信息存储的机理不同可以分为两类：

- SRAM：静态读写存储器
- DRAM：动态读写存储器

### SRAM存储器

#### 基本的静态存储元阵列

1. 存储位元
2. 三组信号线
   - 地址线
   - 数据线
   - 控制线

![基本的静态存储元阵列](./计算机原理03-内存存储器/基本的静态存储元阵列.png)

#### 逻辑结构与地址译码器

- 基本的SRAM逻辑结构
  - SRAM采用双译码方式，将地址分成x向、y向两部分
- 地址译码器
  - 采用双译码的方式（减少选择线的数目）。
  - A0~A7为行地址译码线，A8~A14为列地址译码线

![逻辑结构与地址译码器](./计算机原理03-内存存储器/逻辑结构与地址译码器.png)

#### 存储器的读写周期

- 读周期
  - 读出时间$t_{AQ}$
  - 读周期时间$t_{RC}$
- 写周期
  - 写周期时间$t_{WC}$
  - 写时间$t_{WD}$
- 存取周期
  - $读周期时间t_{RC}=写周期时间t_{WC}$

![SRAM存储器的读写周期](./计算机原理03-内存存储器/SRAM存储器的读写周期.png)

### DRAM存储器

#### DRAM存储位元的记忆原理
 		
SRAM存储器的存储位元是一个触发器，它具有两个稳定的状态。而DRAM存储器的存储位元是由一个MOS晶体管和电容器组成的记忆电路。 


#### 读/写周期

- 读周期、写周期的定义是从行选通信号RAS下降沿开始，到下一个RAS信号的下降沿为止的时间，也就是连续两个读/写周期的时间间隔。
- 通常为控制方便，读周期和写周期时间相等。

![DRAM存储器的读写周期](./计算机原理03-内存存储器/DRAM存储器的读写周期.png)

#### 刷新周期 

- 必须定期地刷新DRAM ，以保持它们原来记忆的正确信息。
- 刷新操作有两种刷新方式：
  - 集中式刷新:DRAM的所有行在每一个刷新周期中都被集中刷新。
  - 分散式刷新:每一行的刷新插入到正常的读/写周期之中。

#### 存储器容量的扩充 

1. 字长位数扩展
   - 给定的芯片字长位数较短，不满足设计要求的存储器字长，此时需要用多片给定芯片扩展字长位数。
   - 三组信号线中，地址线和控制线公用而数据线单独分开连接。
   - 所需芯片数量=设计要求的存储器容量/选择芯片存储器容量
2. 字存储容量扩展 
   - 给定的芯片存储容量较小（字数少），不满足设计要求的总存储容量，此时需要用多片给定芯片来扩展字数。
   - 三组信号组中给定芯片的地址总线和数据总线公用，控制总线中R/W公用，使能端EN不能公用，它由地址总线的高位段译码来决定片选信号。
   - 所需芯片数=设计要求的存储器容量/选择芯片存储器容量

### SRAM和DRAM对比

|名称|存储单元|存储方式|存储密度|速度|安全性|价格|
|---|---|---|---|---|---|---|
|SRAM（机械硬盘）|6个晶体管|触发器（01两种状态）|小|快|高|贵|
|DRAM（SSD）|4个晶体管|电容效应（充放电效应）|大|慢|低（电容放电，注意刷新）|便宜|

# 只读存储器和闪存存储器

## 只读存储器

ROM叫做只读存储器。顾名思义，只读的意思是在它工作时只能读出，不能写入。然而其中存储的原始数据，必须在它工作以前写入。只读存储器由于工作可靠，保密性强，在计算机系统中得到广泛的应用。主要有两类：

- 掩模ROM：掩模ROM实际上是一个存储内容固定的ROM，由生产厂家提供产品。 
- 可编程ROM：用户后写入内容，有些可以多次写入。
  - 一次性编程的PROM
  - 多次编程的EPROM和$E^2$PROM。

ps:E表示可擦除,一开始的EPROM需要专业设备擦除，后来发展为可点擦除，EPROM代表擦除的PROM

### 闪速存储器

FLASH存储器也翻译成闪速存储器，它是高密度非失易失性的读/写存储器。高密度意味着它具有巨大比特数目的存储容量。非易失性意味着存放的数据在没有电源的情况下可以长期保存。总之，它既有RAM的优点，又有ROM的优点，称得上是存储技术划时代的进展。 

# 并行存储器

由于CPU和主存储器之间在速度上是不匹配的，这种情况便成为限制高速计算机设计的主要问题。为了提高CPU和主存之间的数据传输率，除了主存采用更高速的技术来缩短读出时间外，还可以采用并行技术的存储器 

## 双端口存储器

双端口存储器由于同一个存储器具有两组相互独立的读写控制电路而得名。由于进行并行的独立操作，因而是一种高速工作的存储器，在科研和工程中非常有用。

![并行存储器](./计算机原理03-内存存储器/并行存储器.png)

## 多模块交叉存储器

一个由若干个模块组成的主存储器是现行编址的

- 地址在模块中如何安排
  - 顺序方式
  - 较差方式

![多模块交叉存储器](./计算机原理03-内存存储器/多模块交叉存储器.png)

## 存储方式

### 顺序方式

假设有n个存储体，每个存储体的容量为m个存储单元

![顺序方式](./计算机原理03-内存存储器/顺序方式.png)

- M0－M3共四个模块，每个模块8个字
  - M0：0—7
  - M1：8－15
  - M2：16－23
  - M3：24－31
- 5位地址组织如下： X X    X X X
- 高位选模块，低位选块内地址
- 某个模块进行存取时，其他模块不工作，优点是某一模块出现故障时，其他模块可以照常工作，通过增添模块来扩充存储器容量比较方便。缺点是各模块串行工作，存储器的带宽受到了限制。

### 交叉方式

可以实现多模块流水式并行存取

![交叉方式](./计算机原理03-内存存储器/交叉方式.png)

- M0－M3共四个模块，每个模块8个字
  - M0：0，4,...除以4余数为0
  - M1：1，5,...除以4余数为1
  - M2：2，6,...除以4余数为2
  - M3：3，7,...除以4余数为3
- 5位地址组织如下： X X X    X X
- 高位选块内地址，低位选模块
- 特点：连续地址分布在相邻的不同模块内，同一个模块内的地址都是不连续的。优点是对连续字的成块传送可实现多模块流水式并行存取，大大提高存储器的带宽。使用场合为成批数据读取。

# Cache存储器

- cache是介于CPU和主存之间的小容量存储器，存取速度比主存快
- 在主存容量配置几百兆的情况下，Cache的典型值是几百KB
- 从功能上看，Cache是主存的缓冲存储器，由高速的SRAM组成
- 为了追求高速，包括管理在内的全部功能由硬件实现，对程序员是透明的
- 随着半导体器件集成度的提高，已将Cache放入CPU内部，工作速度接近于CPU的速度
- 能组成两级以上的Cache系统
  - 片外Cache：控制逻辑一般与主存控制逻辑合成在一起
  - 片内Cache：控制逻辑在CPU内

![Cache存储器1](./计算机原理03-内存存储器/Cache存储器1.png)

- Cache分为4行，每行4个字
- 分配给Cache的地址存放在相联存储器(CAM)中，它是按内容寻址的存储器

![Cache存储器2](./计算机原理03-内存存储器/Cache存储器2.png)

- 命中率
- 增加Cache的目的是在性能上使主存访问的平均读出时间尽可能接近Cache的读出时间
- 所以希望Cache的命中率应接近于1

## 定量分析

### 命中率

$$
h = \frac{N_c}{N_c+N_m}
$$

其中： $N_c$表示Cache完成存取的总次数；<br/>
$N_m$表示主存完成存取的总次数

### 平均访问时间

若$t_c$表示命中时的cache访问时间，$t_m$表示未命中时的主存访问时间，1-h表示未命中率，则cache/主存系统的平均访问时间$t_a$为：

$t_a = ht_c + (1- h)t_m$

目标是以较小的硬件代价使平均访问时间$t_a$越接近$t_c$越好。<br/>
命中率h与程序的行为、cache的容量、组织方式、块的大小有关。

## 例题

CPU执行一段程序时，cache完成存取的次数为1900次，主存完成存取的次数为100次，已知cache存取周期为50ns，主存存取周期为250ns，求cache/主存系统的平均访问时间。

**解：**

$$
\begin{aligned}
h &= \frac{N_c}{N_c+N_m} = \frac{1900}{1900+100} = 0.95\\
t_a &= ht_c + (1-h)t_m = 0.95 \times 50 + 0.05 \times 250\\
&= 60 
\end{aligned}
$$

## 主存与Cache的地址映射

- 在每种映射方式中，都把主存和cache划分为同样大小的“块”。
- 选择哪种映射方式，要考虑：
  - 硬件是否容易实现
  - 地址变换的速度是否快
  - 主存空间的利用率是否高
  - 主存装入一块时，发生冲突的概率
- 三种映射方法
  1. 全相联
  2. 直接映射
  3. 组相联

### 全相联的映射方式（多对多映射）

- Cache的数据块大小称为行，主存的数据块大小称为块
- 行与块是等长的，每个块(行)由$k＝2_w$个连续的字组成
- Cache行的标记部分存放主存的块地址（块号）

![全相联的映射方式](./计算机原理03-内存存储器/全相联的映射方式.png)

1. 将地址分为两部分（块号和字），在内存块写入Cache时，同时写入块号标记。
2. CPU给出访问地址后，也将地址分为两部分（块号和字），比较块号与Cache表中的标记位，如果相同表示命中，则访问相应单元；如果没有命中则访问内存，并将被访问内存的相对应块写入Cache。
3. 特点：
   - 优点：冲突概率小，Cache的利用高。
   - 缺点：比较器难实现，需要一个访问速度很快代价高的相联存储器
4. 应用场合：适用于小容量的Cache

### 直接映射方式(多对一映射)

- 一个主存块只能拷贝到Cache的一个特定行位置
- Cache的行号i和主存的块号j关系为：i=j  mod  m
- 也就是说，主存中第0、m、2m……块只能映射到第0行

![直接映射方式](./计算机原理03-内存存储器/直接映射方式.png)

1. 利用行号选择相应行；
   - 把行标记与CPU访问地址进行比较，相同表示命中，访问Cache；
   - 如果没有命中，访问内存，并将相应块写入Cache
2. 特点
   - 优点：比较电路少m倍线路，所以硬件实现简单，Cache地址为主存地址的低几位，不需变换。
   - 缺点：冲突概率高（抖动）
3. 应用场合:适合大容量Cache

### 组相联映射方式

- 组相联映射方式是前两者的折衷方案，适度地兼顾了二者的优点又尽量避免了二者的缺点，因此被普遍采用
- 方法：将Cache分成u组，每组v行（m = u×v)，组间直接映射，组内全相联映射

![组相联映射方式](./计算机原理03-内存存储器/组相联映射方式.png)

**分析：比全相联容易实现，冲突低**

- 每组只有一行（v=1），则为直接相联映射方式
- 只有一组（u=1），则为全相联映射方式
- v的取值一般比较小， 一般是2的幂，称之为v路组相联cache.

#### 替换策略

- LRU（近期最少使用） ：被访问的行计数器置0，其他的计数器增加1，换值大的行，符合cache的工作原理
- 随机替换：随机替换策略实际上是不要什么算法，从特定的行位置中随机地选取一行换出即可。这种策略在硬件上容易实现，且速度也比LRU策略快。缺点是随意换出的数据很可能马上又要使用，从而降低命中率和cache工作效率。但这个不足随着cache容量增大而减小。随机替换策略的功效只是稍逊于LRU策略。

### 写操作策略

- 由于cache的内容只是主存部分内容的拷贝，它应当与主存内容保持一致。而CPU对cache的写入更改了cache的内容。如何与主存内容保持一致，可选用如下两种写操作策略。
- 写回法：换出时，对行的修改位进行判断，决定是写回还是舍掉。
- 全写法：写命中时，Cache与内存一起写