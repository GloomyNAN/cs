---
title: 面向对象技术及C++06-虚函数和多态性
date: 2020-07-20 17:07:28
---

## 6.1 引言

**虚函数**（virtual function）和**多态性**（polymorphism）使得设计和实现易于扩展（extensible）的软件系统成为可能。

应用系统开发可以以“应用系统框架”（application framework）为基础。应用系统框架处理通用类对象，应用开发者从框架触发，逐步细化，定义各种具体的类，由派生类对框架进行加工。

在开发过程中，不论类是否已经建立，程序员都可利用虚函数和多态性先编写处理这些对象的程序代码。这可加快整个软件产品的开发进度。

## 6.2 类型域和switch语句

通过基类指针访问对象，如果对于不同类的对象要采取不同的动作，则switch语句可用于处理各种不同类型的对象。只要我们在每个对象中设置一个类型域(type tag)就能使用switch语句。 

### 使用switch语句的缺陷:

1. 程序员可能会忘记对每个对象的类型测试
2. 在swith局与众可能会忘记测试所有可能的对象类型
3. 增加新的派生类时，没有再switch遇见中增加测试新类的代码
4. 增加新的派生类是，在switch遇见中增加测试新类的代码，既费时，又容易出错

采用虚函数方法处理不同对象的动作，可避免使用switch语句所造成的缺陷，可以简化编程，有助于测试、调试与维护。

## 6.3 虚函数

虚函数是C++语言实现动态多态性的手段。系统自动根据对象类型（而不是专门设一个类型域）在程序运行时确定它应调用的函数版本，在编译时不会确定一个虚函数的调用对应于哪个函数版本。

### 使用虚函数的例子：

从形状类Shape可以派生出圆Circle、三角形Triangle、矩形Rectangle、正方形Square等等。每个类都有一个成员函数Draw，表示在屏幕上画出自己的形状。使用者使用Shape*调用Draw，那么要使画出的形状都正确，必须根据对象类型来确定使用哪个Draw来画。将Draw在Shape中定义为虚函数，并在每个派生类中重新定义该函数，那么当程序运行时，系统自动调用合适的Draw函数版本。

### 虚函数的定义方法

在类定义过程中，在成员函数的原型说明前加一个关键字virtual。     
例如 ：        

```c++
class Shape          
{    
    virtual void Draw( );   
}; 
```

中Draw函数被定义为是一个虚函数。 

在类层次中，一个函数被定义成虚函数后，它在所有派生类中一直为虚函数。在派生类的虚函数原型说明前可以不加virtual说明，但它仍然为一个虚函数。 虚函数也能被继承。当派生类中没有重新定义虚函数的新版本时，派生类也能使用基类中的虚函数版本。

### 动态联编：

定义虚函数之后，当利用基类指针（或对基类的引用）调用虚函数时，系统自动在程序运行时（不是在编译时）确定应使用哪个虚函数的版本来执行。这一确定过程就称为动态联编(dynamic binding)，也称延迟绑定(late binding)。 

### 静态联编：

当利用基类指针（或对基类的引用）调用非虚函数时，系统在编译期间（不是在运行时）就能确定应使用哪个函数的版本。这一确定过程就称为静态联编(static binding)，也称早期绑定(early binding)。 通过基类对象名调用虚函数时，编译器也把函数调用确定为是基类的虚函数，这时实行的也是静态联编。 

### 虚函数的重定义:

在派生类中重新定义的虚函数必须与基类中的虚函数具有完全相同的函数名、参数类型和返回类型。即函数原型要完全一致，否则会将派生类中的函数认为不是基类虚函数的重定义版本，而是一个新增的成员函数。

## 6.4 抽象基类和具体类

## 6.5 多态性

## 6.6 实例研究:利用多态性的工资单系统

## 6.7 新类和动态联编

当向类层次中增加新的派生类后，通过类层次中的基类访问的虚函数所体现出的多态性也能很好地工作。 

对于要被编译的虚函数调用来说，编译时可以不知道对象的类型（甚至派生类可能还没有建立）。在程序运行时，虚函数调用和被调用对象的虚函数版本匹配。

虚函数的实现机制是：每个包含虚函数的类建立一张虚函数表(vtable)，它是一个包含各个虚函数指针的数组，虚函数指针指向类的对象所要使用的虚函数版本。带有虚函数的类对象都包含一个指向该类vtable的指针。系统在运行时获取并使用正确的函数指针完成函数调用。

## 6.8 虚析构函数



## 6.9 实例研究:继承接口和实现



![通用计算机分类](./面向对象技术及C++06-虚函数和多态性/通用计算机分类.png)